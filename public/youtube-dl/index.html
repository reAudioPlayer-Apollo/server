<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <title>Apollo - Web / Youtube Downloader</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="/index-src/master.css" type="text/css" rel="stylesheet" />

    <link href="/index-src/scrollbars.css" type="text/css" rel="stylesheet" />

    <script type="text/javascript" src="/src/spotify.js"></script>
    <script type="text/javascript" src="/youtube-dl/youtube-dl.js"></script>
</head>

<body>
    <div class="wrapper">
        <div id="overlay" class="overlay hidden">
            <div class="overlay-header">
                <a class="root-link" href="/"> <h1>reAudioPlayer Apollo - Web</h1> </a>
                <span onclick="closeOverlay()" class="material-icons-outlined">close</span>
            </div>
            <div class="link-wrapper">
                <div class="function">
                    <a href="/spotify">Release Radar</a><br>
                </div>
                <div class="function">
                    <a href="/share">File Sharing</a><br>
                </div>
                <div class="function">
                    <a href="/visualiser/v2">Streamer</a><br>
                </div>
                <div class="function">
                    <a href="/youtube-dl">Youtube Downloader</a><br>
                </div>
                <a class="hidden" href="https://icons8.com/icon/7820/male-user">Male User icon by Icons8</a>
            </div>
        </div>

        <div class="main">
            <div class="header">
                <div class="title">
                    <a class="root-link" onclick="openOverlay()" > <h1>reAudioPlayer Apollo - Web / Youtube Downloader</h1> </a>
                </div>
                <div class="user">
                    <div id="user-loggedIn" class="loggedIn">
                        <div class="userinfo">
                            <img alt="avatar" id="user-icon"
                                src="https://img.icons8.com/ios/60/000000/user-male-circle.png">
                            <a href="/settings" id="user-email">Your Email</a>
                        </div>
                        <div class="logout">
                            <a href="/logout">Log Out</a>
                        </div>
                    </div>
                    <div id="user-loggedOut" class="loggedOut">
                        <a href="/login">Log In</a>
                    </div>
                </div>
            </div>
            <div class="body" id="body">
                <button style="margin: 20px;margin-bottom: 5px;" id="btnDownload" onclick="download()"
                    class="negative">Download</button>

                <div class="function">
                    <h3>Youtube Video</h3>
                    <label for="code">Youtube Link:</label>
                    <span contenteditable="true" id="yt" class="text-input"
                        oninput="updateYoutubePreview(innerText)"></span><br><br>
                </div>
                <div class="function">
                    <h3>Spotify Song</h3>
                    <label for="code">Spotify Link:</label>
                    <span contenteditable="true" id="sp" class="text-input"
                        oninput="updateSpotifyPreview(innerText)"></span><br><br>
                </div>

                <div class="function">
                    <h3>Preview</h3>
                    <div class="iframes">
                        <iframe id="youtubePreviewFrame" src="" title="YouTube video player" frameborder="0"
                            allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                        <iframe src="" id="spotifyPreviewFrame" height="380" frameBorder="0" allowtransparency="true"
                            allow="encrypted-media"></iframe><br><br>
                    </div>
                </div>

                <div class="function">
                    <h3>Metadata Analyser</h3>
                    <h4 class="maybe" id="title">Title</h4>
                    <p id="title-sp"><b>Spotify:</b> Test S</p>
                    <p id="title-yt"><b>Youtube:</b> Test Y</p>
                    <h4 class="maybe" id="artist">Artist</h4>
                    <p id="artist-sp"><b>Spotify:</b> Artist S</p>
                    <p id="artist-yt"><b>Youtube:</b> Artist Y</p>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    function openOverlay()
    {
        document.getElementById("overlay").classList.remove("hidden")
    }
    
    function closeOverlay()
    {
        document.getElementById("overlay").classList.add("hidden")
    }
</script>

<style>
    .good {
        color: #00c48b;
    }

    .bad {
        color: #e85454;
    }

    .maybe {
        color: #c7aa19;
    }

    #btnDownload {
        width: calc(100vw - var(--scrollbar-width) - 40px);
    }

    iframe {
        margin: 5px;
        border-radius: 10px;
    }

    iframe#youtubePreviewFrame {
        flex-grow: 0;
        min-width: 50%;
    }

    iframe#spotifyPreviewFrame {
        flex-grow: 0;
    }

    .iframes {
        display: flex;
        flex-direction: row;
        align-content: stretch;
        justify-content: space-evenly;
    }

    .body {
        overflow-x: hidden;
        overflow-y: auto;
        max-height: 90vh;
    }
</style>

<script>
    setScrollbarWidth();
    setTimeout(() => setScrollbarWidth(), 5000);

    async function updateYoutubePreview(id) {
        id = ytdl.youtubeParser(id);
        document.getElementById("youtubePreviewFrame").src = `https://www.youtube.com/embed/${id}`;

        const data = await fetch(`https://noembed.com/embed?url=${encodeURI(`https://www.youtube.com/watch?v=${id}`)}`)
        window.ytdata = await data.json();

        compareMetadata();
    }

    async function updateSpotifyPreview(id) {
        id = ytdl.spotifyParser(id);
        document.getElementById("spotifyPreviewFrame").src = `https://open.spotify.com/embed/track/${id}`;

        const res = await fetch(`/spotify/metadata/song/${id}/token/${window.accessToken}`)
        window.spdata = await res.json();

        compareMetadata();
    }

    function compareMetadata()
    {
        document.getElementById("artist-yt").innerHTML = `<b>Youtube:</b> ${ytdata?.author_name}`
        document.getElementById("artist-sp").innerHTML = `<b>Spotify:</b> ${spdata?.artist}`

        document.getElementById("title-yt").innerHTML = `<b>Youtube:</b> ${ytdata?.title}`
        document.getElementById("title-sp").innerHTML = `<b>Spotify:</b> ${spdata?.title}`

        if (!ytdata || !spdata)
        {
            return;
        }

        const titleEqual = ytdata.title == spdata.title;
        const artistEqual = ytdata.author_name == spdata.artist;

        if (titleEqual)
        {
            document.getElementById("title").className = "good"
        }
        else
        {
            const titlesY = ytdata.title.toLowerCase().split(' ');

            for (const title of titlesY)
            {
                if (spdata.title.toLowerCase().includes(title))
                {
                    document.getElementById("title").className = "maybe"
                    break;
                }
                else
                {
                    document.getElementById("title").className = "bad";
                }
            }
        }

        if (artistEqual)
        {
            document.getElementById("artist").className = "good"
        }
        else
        {
            const artistsY = ytdata.author_name.toLowerCase().split(' ');

            for (const artist of artistsY)
            {
                if (spdata.artist.toLowerCase().includes(artist))
                {
                    document.getElementById("artist").className = "maybe"
                    break;
                }
                else
                {
                    document.getElementById("artist").className = "bad";
                }
            }
        }
    }

    function setScrollbarWidth() {
        document.documentElement.style.setProperty('--scrollbar-width', (window.innerWidth - document.documentElement
            .clientWidth) + "px")
    }

    async function download() {

        const yt = document.getElementById("yt")
        const sp = document.getElementById("sp")

        const yti = yt.innerText;
        const spi = sp.innerText;

        ytdl.download(yti, spi);
    }

    fetch("/user/get")
        .then(x => {
            console.log(x.status)
            if (x.status == 401) { // logged out
                document.getElementById("user-loggedOut").classList.remove("hidden")
                document.getElementById("user-loggedIn").classList.add("hidden")
                document.getElementById("body").classList.add("hidden")
                console.log("logged out")
                return;
            } else { // logged in
                document.getElementById("user-loggedOut").classList.add("hidden")
                document.getElementById("user-loggedIn").classList.remove("hidden")
                document.getElementById("body").classList.remove("hidden")
                console.log("logged in")
                spotifyStart("youtube-dl", json => {
                    window.jdata = json;
                    let text = "";
                    for (let i = 0; i < json.length; i++) {
                        const release = json[i];
                        text +=
                            `<div class="card"><img onclick="window.open('${release["external_urls"].spotify}')" src="${release.images[0].url}"><h4>${release.name}</h4><h5>${release.artists.map(x => x.name).join(", ")}</h5><button class="text-button" onclick="search(${i})">Search On Youtube Music</button></div>`
                    }

                    document.getElementById("spotify-preview").innerHTML = text;
                    setScrollbarWidth();
                }, true);
                return x.json()
            }
        })
        .then(json => {
            if (json && json.user) {
                document.getElementById("user-icon").src = json.user.picture
                document.getElementById("user-email").innerText = json.user.email
            }
        })
</script>