<input type="file" id="input" onchange="share()">
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<img id="image" width="200px" height="200px">
<audio controls id="audio"><source id="mp3Source" type="audio/mp3"></audio>
<input type="text" id="code">
<input type="text" id="subscription">
<button onclick="subscribe()">subscribe</button>
<script>
window.socket = io();

function share(file) {
    console.log("sending...")
    console.log(file)
    var chunks = [ ]
    var chunkSize = 1000 * 1000
    let i = chunkSize

    for (; i < file.size; i += chunkSize)
    {
        chunks.push(file.slice(i - chunkSize, i))
    }

    chunks.push(file.slice(i - chunkSize))

    for (let j = 0; j < chunks.length; j++)
    {
        msg = {
            chunk: chunks[j],
            name: file.name,
            type: file.type,
            code: document.getElementById("code").value,
            chunkIndex: j,
            chunkCount: chunks.length
        }

        window.socket.emit('share', msg);
    }
    console.log("sent")
}

function subscribe()
{
    window.socket.emit("file subscribe", document.getElementById("subscription").value)
}

/*document.getElementById('input').addEventListener('change', function() {

const reader = new FileReader();
reader.onload = function() {
  const bytes = new Uint8Array
  console.log(bytes)
};
reader.readAsArrayBuffer(this.files[0]);

}, false);*/

let chunks = [ ]

window.socket.on("received", msg => {
    if (msg.chunkIndex == 0)
    {
        chunks = [ ];
    }
    chunks.push(msg.chunk)
    if (msg.chunkIndex == msg.chunkCount - 1)
    {
        var blob = new Blob([...chunks], {type: msg.type});
        var src = window.URL.createObjectURL(blob);

        if (String(msg.type).includes("audio"))
        {
            window.player = document.getElementById("audio")
            window.mp3Source = document.getElementById("mp3Source")
            window.player.src = src
            window.player.play();
        }
        else
        {
            document.getElementById("image").src = src
        }
    }
})
</script>